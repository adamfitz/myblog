<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Site-to-Site IPSEC VPN configuration &middot; Adam Fitzgerald</title>
        <meta name="description" content="s2s vpn">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.105.0">
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="og:title" content="Site-to-Site IPSEC VPN configuration">
<meta property="og:description" content="s2s vpn">
<meta property="og:type" content="article">
<meta property="og:url" content="//networknoob.net/projects/site-to-site-vpn-vs-mpls/">
        <link rel="stylesheet" href="//networknoob.net/dist/site.css">
        <link rel="stylesheet" href="//networknoob.net/dist/syntax.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        
        
        
        
        

    </head>
    <body>
        

        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a href="//networknoob.net/">Networknoob</a>
                            </h1>
                        
                        
                            <a class="button-square" href="//networknoob.net/index.xml" aria-label="RSS"><i class="fa fa-rss" aria-hidden="true"></i></a>
                        
                        
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" aria-label="Github" href="https://github.com/adamfitz" rel="me">
                                <i class="fa fa-github-alt" aria-hidden="true"></i>
                            </a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="LinkedIn" aria-label="LinkedIn" href="https://www.linkedin.com/in/adam-fitzgerald-89247445/" rel="me">
                                <i class="fa fa-linkedin" aria-hidden="true"></i>
                            </a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Email" aria-label="Send an Email" href="mailto:adam@networknoob.net">
                                <i class="fa fa-envelope" aria-hidden="true"></i>
                            </a>
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a href="/post">blogs</a>
    </li>

    <li class="site-nav-item">
        <a href="/projects/">projects</a>
    </li>

    <li class="site-nav-item">
        <a href="/page/contact/">contact</a>
    </li>

    <li class="site-nav-item">
        <a href="/page/about/">about</a>
    </li>

    <li class="site-nav-item">
        <a href="/tags">tags</a>
    </li>


                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container">
        <header class="post-header">
    <h1 class="post-title">Site-to-Site IPSEC VPN configuration</h1>
    
        <p class="post-description">s2s vpn</p>
    
</header>

        <div class="post-content clearfix">
    

    <p><strong>This is a repost of a site to site VPN config with low end Cisco ISR routers, I wrote a few years ago as a proof of concept for replacing a small MPLS network for a managed service provider I was working for. At the time I had not setup ipsec VPNs before so I documented the steps I went through here..</strong>.</p>
<p>The purpose of this post is to document the configuration commands and give an outline to the process of configuring site to site VPN connection as I had a little trouble getting a clear picture of what each command did and why it was being used. In this instance the two end points are Cisco 857w routers connected directly to the internet with PAT enabled.</p>
<p>I started with a general config and a link to this site to site vpn post from <a href="http://learnnetworkingwithme.wordpress.com/2011/12/18/cisco-ipsec-site-to-site-configuration/" title="Learn Networking with Me">Learn Networking with Me</a> which gives some good explanations of what to do and why. The VPN configuration on each of my routers is as follows:</p>
<p><strong>Router 1 – Home</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">crypto isakmp policy <span class="m">1</span>
</span></span><span class="line"><span class="cl"> encr aes
</span></span><span class="line"><span class="cl"> authentication pre-share
</span></span><span class="line"><span class="cl"> group <span class="m">2</span>
</span></span><span class="line"><span class="cl">crypto isakmp key Pa55w0rd address <span class="nv">$OfficeRouterPublicIPAddress</span> no-xauth
</span></span><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">!  
</span></span><span class="line"><span class="cl">crypto ipsec transform-set Tunnel_to_Office esp-aes esp-sha-hmac
</span></span><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">crypto map Home_To_Office <span class="m">10</span> ipsec-isakmp
</span></span><span class="line"><span class="cl"> <span class="nb">set</span> peer <span class="nv">$OfficeRouterPublicIPAddress</span>
</span></span><span class="line"><span class="cl"> <span class="nb">set</span> transform-set Tunnel_to_Office
</span></span><span class="line"><span class="cl"> match address <span class="m">101</span>
</span></span></code></pre></div><p><strong>Router 2 – Office</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">crypto isakmp policy <span class="m">1</span>  
</span></span><span class="line"><span class="cl"> encr aes  
</span></span><span class="line"><span class="cl"> authentication pre-share  
</span></span><span class="line"><span class="cl"> group <span class="m">2</span>  
</span></span><span class="line"><span class="cl">crypto isakmp key Pa55w0rd address <span class="nv">$HomeRoutersPublicIPAddress</span> no-xauth  
</span></span><span class="line"><span class="cl">!  
</span></span><span class="line"><span class="cl">!  
</span></span><span class="line"><span class="cl">crypto ipsec transform-set Tunnel_to_Home esp-aes esp-sha-hmac   
</span></span><span class="line"><span class="cl">!  
</span></span><span class="line"><span class="cl">crypto map Office_To_Home <span class="m">10</span> ipsec-isakmp   
</span></span><span class="line"><span class="cl"> <span class="nb">set</span> peer  <span class="nv">$HomeRoutersPublicIPAddress</span>
</span></span><span class="line"><span class="cl"> <span class="nb">set</span> transform-set Tunnel_to_Home   
</span></span><span class="line"><span class="cl"> match address <span class="m">101</span>
</span></span></code></pre></div><p>Referring to Learn Networking with Me’s link the <strong>crypto isakmp policy</strong> sets up phase 1 tunnel with the peer router. The <strong>crypto ipsec transform</strong> configures the ipsec tunnel encryption scheme and calls it Tunnel_to_Office. The <strong>crypto map</strong> is the policy which defines the data flows and the crypto peer to send it to, here the office and home routers public IP is defined as each peer and refers to the transform set for the type of encryption to use.</p>
<p>The <strong>match 101</strong> refers to the access list which will allow or deny traffic through the tunnel. I stumbled a little bit with these as I have had little practice with access lists in the cisco world.</p>
<p><strong>Router 1 – Home</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">access-list <span class="m">101</span> permit ip 10.23.0.0 0.0.0.255 10.0.0.0 0.255.255.255
</span></span></code></pre></div><p>Here this access list is permitting the IP range 10.23.0.0/24 to send traffic to any ip address in the 10.0.0.0/8 range. The local LAN at home is 10.23.0.0/24 and if packets are sent to any address in the 10.0.0.0/8 range it will be sent across the VPN tunnel.</p>
<p><strong>Router 2 – Office</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">access-list <span class="m">101</span> permit ip 10.0.0.0 0.255.255.255 10.23.0.0 0.0.0.255
</span></span></code></pre></div><p>The access list on the office router is the reverse of the home router allowing all traffic from the 10.0.0.0/8 being sent to 10.23.0.0/24 to be sent across the tunnel.</p>
<p>Once the tunnel and the access list for the tunnels are setup I applied the crypto map to an interface on each router so that when traffic was sent to each specified network range it could be matched and forwarded across the VPN tunnel. The crypto map needs to be applied to the Public interface (in this instance) so that when traffic is sent to an address which is not on the local LAN the packet will use the default route to the Dialer1 interface which is then matched by the <strong>match address 101</strong> command in the crypto map and sent down the VPN tunnel.</p>
<p>For the office router I needed to put a static route in for my home network as it already had routes for the 10.0.0.0/8 ranges being forwarded to another MPLS router in the office. Otherwise the traffic for 10.23.0.0/24 would have been forwarded incorrectly to the local MPLS router rather than to the VPN tunnel.</p>
<p><strong>Router 2 – Office</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip route 10.0.0.0 255.0.0.0 10.2.0.254 
</span></span><span class="line"><span class="cl">ip route 10.23.0.0 255.255.255.0 Dialer1
</span></span></code></pre></div><p>At this stage I knew I was pretty close with this configuration, to bring up the VPN tunnel however I needed to ping from the local LAN interface on my home router to a subnet in the office, this would match the traffic, bring up the VPN and successfully pass the traffic across the tunnel. But I just couldn’t get the tunnel to come up, I would traceroute to a subnet in the office but the packet was hitting the dialer interface and trying to go to the internet without being matched and I had no idea why, so I opened a TAC case.</p>
<p>The engineer was awesome and had a very good understanding of what I was trying to achieve, a couple of emails later he suggested that Phase 2 was up but the traffic was not being sent across the VPN because of NAT overload, all the outbound traffic was being NAT’ed.</p>
<p><strong>Router 1 – Home</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip nat inside <span class="nb">source</span> list <span class="m">199</span> interface Dialer1 overload  
</span></span><span class="line"><span class="cl">!  
</span></span><span class="line"><span class="cl">!  
</span></span><span class="line"><span class="cl">access-list <span class="m">199</span> deny ip 10.23.0.0 0.0.0.255 10.0.0.0 0.255.255.255  
</span></span><span class="line"><span class="cl">access-list <span class="m">199</span> permit ip 10.23.0.0 0.0.0.255 any
</span></span></code></pre></div><p>Here we have an extended access list assigned to the Dialer interface allowing NAT overloading (line 1) and below are the IP addresses that are denied or allowed. The first line in the access list indicates that packets sent from the 10.23.0.0/24 network with a destination of 10.0.0.0/8 will be denied the application of NAT however the next line indicates that traffic sent from the 10.23.0.0/24 network to <strong>any other</strong> address ranges would be allowed. The reason for this is to still allow access to the VPN as well as having the ability to port forward in and out of the local LAN.</p>
<p><strong>Router 2 – Office</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip nat inside <span class="nb">source</span> list <span class="m">199</span> interface Dialer1 overload  
</span></span><span class="line"><span class="cl">!  
</span></span><span class="line"><span class="cl">!  
</span></span><span class="line"><span class="cl">access-list <span class="m">199</span> deny ip 10.0.0.0 0.255.255.255 10.23.0.0 0.0.0.255  
</span></span><span class="line"><span class="cl">access-list <span class="m">199</span> permit ip 10.2.0.0 0.0.0.255 any
</span></span></code></pre></div><p>Here on the office router the access list in reverse to the home router, permitting the local LAN addresses to NAT but denying NAT from 10.0.0.0/8 addresses to 10.23.0.0/24.</p>
<p>I had the following debugs running on my router, <strong>terminal monitor</strong>, <strong>debug crypto isakmp</strong>, <strong>debug crypto ipsec</strong>, after running a <strong>clear crypto session</strong> and running another ping from the LAN to an address at the office it was about this point that the screen exploded with output and I knew that I had finally got it up and running.</p>
<p>This configuration is not a particularly difficult one, however as I said earlier I had not setup a site to site VPN before and it took me a good few days of perseverance to get to this point. I am thankful for the help from the TAC guys as well as the information gleaned from the Site to Site VPN article at <a href="http://www.learnnetworkingwithme.wordpress.com" title="Learn Networking with Me">Learn Networking with Me</a>.</p>
<p>The best thing about this little project was that as well as achieving something practical I got to learn quite a few things along the way.</p>

</div>

        <footer class="post-footer clearfix">
        <p class="post-tags">
            <span>Tagged:</span>
                <a href="/tags/vpn/">vpn</a>, 
                <a href="/tags/cisco/">cisco</a>
        </p>
    <div class="share">
    </div>
</footer>
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a href="//networknoob.net/">Networknoob</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#" aria-label="Back to Top">
                        <i class="fa fa-angle-up" aria-hidden="true"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2022 / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="http://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="//networknoob.net/js/jquery-1.11.3.min.js"></script>
        <script src="//networknoob.net/js/jquery.fitvids.js"></script>
        <script src="//networknoob.net/js/scripts.js"></script>
        
    </body>
</html>

